<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Геокарта — Кэшбэк</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Base UI -->
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #0B0B0C;
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      overflow: hidden;
    }

    /* MAP */
    #map {
      width: 100vw;
      height: 100vh;
    }

    /* FILTER PANEL */
    .filter-bar {
      position: fixed;
      bottom: 22px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(20,20,21,0.85);
      backdrop-filter: blur(14px);
      display: flex;
      gap: 10px;
      padding: 10px 16px;
      border-radius: 18px;
      z-index: 9999;
      border: 1px solid rgba(255,255,255,0.08);
    }

    .filter-btn {
      background: #151518;
      color: #e6e6e6;
      border: 1px solid #2A2A2C;
      border-radius: 12px;
      padding: 8px 14px;
      font-size: 15px;
      cursor: pointer;
      transition: 0.25s;
    }

    .filter-btn.active {
      background: #E11D48;
      border-color: #E11D48;
      color: white;
    }

    /* Popup styling */
    .leaflet-popup-content-wrapper {
      background: #ffffff;
      color: #000;
      border-radius: 12px;
      padding: 10px 14px;
    }

    .leaflet-popup-tip {
      background: #ffffff;
    }
  </style>
</head>
<body>

<!-- MAP -->
<div id="map"></div>

<!-- FILTERS -->
<div class="filter-bar">
  <button class="filter-btn active" data-cat="all">Все</button>
  <button class="filter-btn" data-cat="active">АЗС</button>
  <button class="filter-btn" data-cat="fastfood">Рестораны</button>
  <button class="filter-btn" data-cat="sport">Спорт</button>
  <button class="filter-btn" data-cat="entertainment">Развлечения</button>
</div>

<script>
/* ==============================
   ИНИЦИАЛИЗАЦИЯ КАРТЫ
   ============================== */
let map = L.map('map').setView([55.75, 37.61], 11);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

/* ==============================
   ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ
   ============================== */
let markers = [];
let currentCategory = "all";

/* ==============================
   ЗАГРУЗКА ТОЧЕК
   ============================== */
function loadPoints() {
  fetch("points.json?v=" + Date.now())  // отключаем кеш GitHub Pages
    .then(res => res.json())
    .then(points => renderPoints(points))
    .catch(err => console.error("Ошибка загрузки points.json:", err));
}

/* ==============================
   ОТРИСОВКА ТОЧЕК
   ============================== */
function renderPoints(points) {
  // удалить старые маркеры
  markers.forEach(m => map.removeLayer(m));
  markers = [];

  points
    .filter(p => currentCategory === "all" || p.cbCategory === currentCategory)
    .forEach(p => {
      let marker = L.marker([p.lat, p.lon]).addTo(map);
      marker.bindPopup(`
        <b>${p.name}</b><br>
        ${p.address}<br>
        Средний чек: ${p.avgCheck} ₽<br>
        Кэшбэк: ${p.cashback}%
      `);
      markers.push(marker);
    });
}

/* ==============================
   ФИЛЬТРЫ
   ============================== */
document.querySelectorAll(".filter-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");

    currentCategory = btn.dataset.cat;
    loadPoints();
  });
});

/* ==============================
   ЗАПУСК
   ============================== */
loadPoints();
</script>

</body>
</html>
