<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ì–µ–æ–∫–∞—Ä—Ç–∞ ‚Äî –∫—ç—à–±—ç–∫</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root {
      --bg-main: #050509;
      --bg-surface: #101015;
      --bg-card: #17171f;
      --bg-chip: #1f1f27;
      --accent: #ff365c;
      --accent-soft: rgba(255, 54, 92, 0.18);
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --border-subtle: rgba(255, 255, 255, 0.08);
      --radius-xl: 22px;
      --radius-lg: 18px;
      --radius-md: 14px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui,
        sans-serif;
      background: var(--bg-main);
      color: var(--text-main);
      overflow: hidden;
    }

    #app {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background: #000;
    }

    /* MAP */
    #map {
      position: absolute;
      inset: 0;
      z-index: 1;
    }

    /* TOP BUTTONS (–Ω–∞–∑–∞–¥ / –∑–∞–∫—Ä—ã—Ç—å) ‚Äì –ø—Ä–æ—Å—Ç–æ –∑–∞–≥–ª—É—à–∫–∏ */
    .top-buttons {
      position: absolute;
      top: env(safe-area-inset-top, 10px);
      left: 0;
      right: 0;
      padding: 8px 16px;
      display: flex;
      justify-content: space-between;
      z-index: 20;
      pointer-events: none;
    }

    .circle-btn {
      pointer-events: auto;
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(5, 5, 10, 0.88);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-main);
      font-size: 16px;
      cursor: pointer;
    }

    .circle-btn.hidden {
      visibility: hidden;
    }

    /* MAIN PANEL (–∫–∞–∫ –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ) */
    .main-panel {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 10;
      padding: 10px 0 12px;
      pointer-events: none;
    }

    .main-inner {
      pointer-events: auto;
      margin: 0 8px env(safe-area-inset-bottom, 8px);
      padding: 10px 10px 12px;
      border-radius: 24px 24px 0 0;
      background: radial-gradient(
          circle at 10% 0,
          rgba(255, 255, 255, 0.05),
          transparent 45%
        ),
        rgba(7, 7, 12, 0.98);
      border: 1px solid var(--border-subtle);
      box-shadow: 0 -18px 40px rgba(0, 0, 0, 0.65);
      max-width: 420px;
      margin-left: auto;
      margin-right: auto;
    }

    .panel-grabber {
      width: 44px;
      height: 4px;
      margin: 0 auto 10px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.5);
    }

    /* SEARCH */
    .search-bar {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      border-radius: 999px;
      background: #15151c;
      border: 1px solid var(--border-subtle);
      color: var(--text-muted);
      font-size: 14px;
      gap: 8px;
    }

    .search-bar input {
      flex: 1;
      border: none;
      outline: none;
      background: transparent;
      color: var(--text-main);
      font-size: 14px;
    }

    /* TABS: –í–∞—à –∫—ç—à–±—ç–∫ / –†—è–¥–æ–º —Å –≤–∞–º–∏ */
    .tabs-row {
      display: flex;
      margin-top: 10px;
      gap: 6px;
    }

    .tab-pill {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: #16161d;
      font-size: 13px;
      text-align: center;
      color: var(--text-muted);
      cursor: pointer;
    }

    .tab-pill.active {
      background: linear-gradient(90deg, #ff365c, #ff8845);
      color: #fff;
      border-color: transparent;
    }

    /* BLUE BANNER "–û—Å–∞–¥–∫–∏" */
    .osadki-banner {
      margin-top: 10px;
      border-radius: var(--radius-lg);
      background: #0ea5e9;
      color: #0b1120;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
    }

    .osadki-left {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      font-weight: 500;
    }

    .osadki-icon {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 17px;
    }

    .osadki-sub {
      font-size: 11px;
      margin-top: 2px;
      opacity: 0.85;
    }

    .osadki-arrow {
      font-size: 16px;
    }

    /* GUIDE (–ì–∏–¥ –ø–æ —Ä–∞–π–æ–Ω—É) */
    .guide-card {
      margin-top: 10px;
      border-radius: var(--radius-lg);
      background: #14141b;
      border: 1px solid var(--border-subtle);
      padding: 10px 12px 12px;
    }

    .guide-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .guide-title {
      font-size: 13px;
      font-weight: 500;
    }

    .guide-steps {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .guide-step-bubble {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      background: #27272f;
      color: #9ca3af;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
    }

    .guide-step-bubble.active {
      background: #f9fafb;
      color: #111827;
      font-weight: 600;
    }

    .guide-body {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
    }

    .guide-main-text {
      max-width: 70%;
    }

    .guide-subtitle {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .guide-next-btn {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: var(--bg-chip);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 17px;
      cursor: pointer;
    }

    /* CASHBACK SHEET (–í–∞—à –∫—ç—à–±—ç–∫) */
    .cashback-sheet {
      margin-top: 10px;
      border-radius: var(--radius-lg);
      background: #111827;
      border: 1px solid var(--border-subtle);
      padding: 8px 10px 10px;
      display: none;
    }

    .cashback-sheet.visible {
      display: block;
    }

    .sheet-title {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .cashback-option {
      margin-top: 4px;
      padding: 8px 6px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
    }

    .cashback-option:hover {
      background: #020617;
    }

    .option-icon {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: #0f172a;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .option-text {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .option-title {
      font-size: 13px;
    }

    .option-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    .option-radio {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid #6b7280;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .option-radio-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: transparent;
    }

    .cashback-option.active .option-radio {
      border-color: var(--accent);
    }

    .cashback-option.active .option-radio-dot {
      background: var(--accent);
    }

    .sheet-lock {
      margin-top: 6px;
      font-size: 11px;
      color: #9ca3af;
      opacity: 0.8;
      padding: 6px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.8);
      text-align: center;
    }

    /* LIST NEAR YOU */
    .near-header {
      margin-top: 10px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .near-list {
      margin-top: 6px;
      max-height: 160px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .near-card {
      border-radius: 16px;
      padding: 8px 10px;
      margin-bottom: 6px;
      color: #f9fafb;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      cursor: pointer;
    }

    .near-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
      font-weight: 500;
    }

    .near-brand {
      font-size: 10px;
      opacity: 0.9;
    }

    .near-meta {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      margin-top: 2px;
    }

    .near-distance {
      opacity: 0.9;
    }

    .near-check {
      opacity: 0.9;
    }

    /* COLOR THEMES FOR NEAR CARDS */
    .near-fastfood {
      background: linear-gradient(90deg, #3b7c26, #16a34a);
    }
    .near-sport {
      background: linear-gradient(90deg, #0f766e, #22c55e);
    }
    .near-entertainment {
      background: linear-gradient(90deg, #b91c1c, #f97316);
    }
    .near-active {
      background: linear-gradient(90deg, #4b5563, #9ca3af);
    }

    /* HEATMAP SCREEN */
    .heat-overlay {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 15;
      padding: 10px 0 14px;
      display: none;
      pointer-events: none;
    }

    .heat-overlay.visible {
      display: block;
    }

    .heat-inner {
      pointer-events: auto;
      margin: 0 8px env(safe-area-inset-bottom, 10px);
      padding: 12px 12px 14px;
      border-radius: 22px;
      background: rgba(7, 7, 12, 0.98);
      border: 1px solid var(--border-subtle);
      max-width: 420px;
      margin-left: auto;
      margin-right: auto;
      text-align: center;
    }

    .heat-title {
      font-size: 14px;
      font-weight: 600;
    }

    .heat-sub {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .heat-card {
      margin-top: 10px;
      border-radius: var(--radius-lg);
      background: #111827;
      border: 1px solid var(--border-subtle);
      padding: 10px 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .heat-card-icon {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #f97316, #ef4444);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .heat-card-text {
      font-size: 12px;
      color: var(--text-muted);
      text-align: left;
    }

    .heat-card-title {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-main);
      margin-bottom: 2px;
    }

    @media (min-width: 768px) {
      .main-inner,
      .heat-inner {
        max-width: 420px;
      }
    }
  </style>
</head>
<body>
<div id="app">
  <div id="map"></div>

  <!-- Top buttons (back from ‚Äú–æ—Å–∞–¥–∫–∏‚Äù) -->
  <div class="top-buttons">
    <button id="btnBack" class="circle-btn hidden" aria-label="–ù–∞–∑–∞–¥">‚Üê</button>
    <button class="circle-btn" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
  </div>

  <!-- MAIN PANEL -->
  <div class="main-panel" id="mainPanel">
    <div class="main-inner">
      <div class="panel-grabber"></div>

      <!-- Search -->
      <div class="search-bar">
        <span>üîç</span>
        <input id="searchInput" type="text" placeholder="–ü–æ–∏—Å–∫" />
      </div>

      <!-- Tabs -->
      <div class="tabs-row">
        <div id="tabCashback" class="tab-pill active">–í–∞—à –∫—ç—à–±—ç–∫</div>
        <div id="tabNear" class="tab-pill">–†—è–¥–æ–º —Å –≤–∞–º–∏</div>
      </div>

      <!-- –û—Å–∞–¥–∫–∏ -->
      <div class="osadki-banner" id="osadkiBanner">
        <div class="osadki-left">
          <div class="osadki-icon">üíß</div>
          <div>
            –û–∂–∏–¥–∞—é—Ç—Å—è –æ—Å–∞–¥–∫–∏ –≤ –≤–∏–¥–µ –∫—ç—à–±—ç–∫–∞
            <div class="osadki-sub">
              –ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ä–µ–¥–Ω–∏–π –∫—ç—à–±—ç–∫ –ø–æ —Ä–∞–π–æ–Ω–∞–º
            </div>
          </div>
        </div>
        <div class="osadki-arrow">‚Ä∫</div>
      </div>

      <!-- –ì–∏–¥ –ø–æ —Ä–∞–π–æ–Ω—É -->
      <div class="guide-card" id="guideCard">
        <div class="guide-header">
          <div class="guide-title">–ì–∏–¥ –ø–æ —Ä–∞–π–æ–Ω—É ‚Ä∫</div>
        </div>
        <div class="guide-steps" id="guideSteps">
          <!-- 5 –∫—Ä—É–∂–∫–æ–≤ -->
        </div>
        <div class="guide-body">
          <div class="guide-main-text">
            <div id="guideTitle">–ü–æ—Å–µ—Ç–∏—Ç–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω</div>
            <div id="guideSub" class="guide-subtitle">
              –ú—ã –ø–æ–¥–æ–±—Ä–∞–ª–∏ –º–µ—Å—Ç–∞ —Å –∫—ç—à–±—ç–∫–æ–º —Ä—è–¥–æ–º —Å –≤–∞–º–∏.
            </div>
          </div>
          <button id="guideNextBtn" class="guide-next-btn" title="–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥">‚úì</button>
        </div>
      </div>

      <!-- –õ–∏—Å—Ç –∫—ç—à–±—ç–∫–∞ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Ç–∞–±–µ "–í–∞—à –∫—ç—à–±—ç–∫") -->
      <div class="cashback-sheet" id="cashbackSheet">
        <div class="sheet-title">–ß—Ç–æ –ø–æ–∫–∞–∂–µ–º?</div>

        <div class="cashback-option" data-cb="fastfood">
          <div class="option-icon">üçî</div>
          <div class="option-text">
            <div class="option-title">5% –§–∞—Å—Ç—Ñ—É–¥</div>
            <div class="option-sub">–î–ª—è –º–æ–ª–æ–¥–µ–∂–∏</div>
          </div>
          <div class="option-radio">
            <div class="option-radio-dot"></div>
          </div>
        </div>

        <div class="cashback-option" data-cb="sport">
          <div class="option-icon">üèÖ</div>
          <div class="option-text">
            <div class="option-title">5% –°–ø–æ—Ä—Ç–∏–≤–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã</div>
            <div class="option-sub">–°–ø–æ—Ä—Ç ‚Äî —ç—Ç–æ –∂–∏–∑–Ω—å</div>
          </div>
          <div class="option-radio">
            <div class="option-radio-dot"></div>
          </div>
        </div>

        <div class="cashback-option" data-cb="entertainment">
          <div class="option-icon">üé≥</div>
          <div class="option-text">
            <div class="option-title">5% –ê–∫—Ç–∏–≤–Ω—ã–π –æ—Ç–¥—ã—Ö</div>
            <div class="option-sub">–ö–∏–Ω–æ, –∫–∞—Ç–∫–∏, —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</div>
          </div>
          <div class="option-radio">
            <div class="option-radio-dot"></div>
          </div>
        </div>

        <div class="sheet-lock">
          –ï—â—ë –æ–¥–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ —Å&nbsp;–ø–æ–¥–ø–∏—Å–∫–æ–π –ê–ª—å—Ñ–∞-–°–º–∞—Ä—Ç
        </div>
      </div>

      <!-- –°–ø–∏—Å–æ–∫ "–†—è–¥–æ–º —Å –≤–∞–º–∏" / "–í–∞—à –∫—ç—à–±—ç–∫" -->
      <div class="near-header" id="nearHeader">–í —Ä–∞–¥–∏—É—Å–µ 3 –∫–º</div>
      <div class="near-list" id="nearList"></div>
    </div>
  </div>

  <!-- HEATMAP OVERLAY -->
  <div class="heat-overlay" id="heatOverlay">
    <div class="heat-inner">
      <div class="heat-title">–°—Ä–µ–¥–Ω–∏–π –∫—ç—à–±—ç–∫ –ø–æ —Ä–∞–π–æ–Ω–∞–º</div>
      <div class="heat-sub">
        –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –æ–±–ª–∞—Å—Ç—å, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–∞–∑–º–µ—Ä —Å—Ä–µ–¥–Ω–µ–≥–æ –∫—ç—à–±—ç–∫–∞.
      </div>

      <div class="heat-card">
        <div class="heat-card-icon">üß≠</div>
        <div class="heat-card-text">
          <div class="heat-card-title">–ù–∞–≤–∏–≥–∞—Ç–æ—Ä –ø–æ —Ä–∞–π–æ–Ω–∞–º</div>
          <div>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫—Ä—É–≥, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä –∫—ç—à–±—ç–∫–∞ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∑–æ–Ω–µ.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // ====== –ö–ê–†–¢–ê ======
  let map, markersLayer, zonesLayer;
  let allPoints = [];
  let filteredPoints = [];
  let currentCbCategory = "all"; // fastfood | sport | entertainment | active | all
  let heatMode = false;

  // –î–ª—è –≥–∏–¥–∞ –ø–æ —Ä–∞–π–æ–Ω—É
  let guideRestaurants = [];
  let guideIndex = 0;

  // "–†–∞–π–æ–Ω—ã" –¥–ª—è —Ä–µ–∂–∏–º–∞ –æ—Å–∞–¥–∫–æ–≤ (–º–æ–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ –≤ average-zones.json)
  const averageZones = [
    { name: "–¶–ê–û", lat: 55.7558, lon: 37.6173, avgCb: 6.5 },
    { name: "–°–ó–ê–û", lat: 55.8031, lon: 37.4096, avgCb: 5.0 },
    { name: "–Æ–ó–ê–û", lat: 55.655, lon: 37.5432, avgCb: 4.0 },
    { name: "–Æ–í–ê–û", lat: 55.69, lon: 37.75, avgCb: 3.5 },
    { name: "–°–í–ê–û", lat: 55.857, lon: 37.624, avgCb: 4.5 }
  ];

  function initMap() {
    map = L.map("map", { zoomControl: false }).setView([55.75, 37.61], 11);

    L.tileLayer(
      "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
      { maxZoom: 19 }
    ).addTo(map);

    markersLayer = L.layerGroup().addTo(map);
    zonesLayer = L.layerGroup().addTo(map);

    loadPoints();
  }

  function loadPoints() {
    // –æ—Ç–∫–ª—é—á–∞–µ–º –∫—ç—à GitHub Pages
    fetch("points.json?v=" + Date.now())
      .then((r) => r.json())
      .then((data) => {
        allPoints = data;
        applyFilters();
        prepareGuide();
      })
      .catch((err) => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ points.json:", err));
  }

  // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ç–µ–∫—É—â–µ–º—É –∫—ç—à–±—ç–∫—É + –ø–æ–∏—Å–∫—É
  function applyFilters() {
    const search = document
      .getElementById("searchInput")
      .value.trim()
      .toLowerCase();

    filteredPoints = allPoints.filter((p) => {
      if (!p.lat || !p.lon) return false;

      // —Ñ–∏–ª—å—Ç—Ä –ø–æ cbCategory
      if (currentCbCategory !== "all" && p.cbCategory !== currentCbCategory) {
        return false;
      }

      // —Ñ–∏–ª—å—Ç—Ä –ø–æ –ø–æ–∏—Å–∫—É
      if (search) {
        const haystack =
          (p.name || "") + " " + (p.address || "") + " " + (p.category || "");
        if (!haystack.toLowerCase().includes(search)) return false;
      }

      return true;
    });

    if (!heatMode) {
      renderMarkers();
    }
    renderList();
  }

  function renderMarkers() {
    markersLayer.clearLayers();
    filteredPoints.forEach((p) => {
      const marker = L.circleMarker([p.lat, p.lon], {
        radius: 6,
        color: "#ffffff",
        weight: 1,
        fillColor: categoryColor(p.cbCategory),
        fillOpacity: 0.9
      }).addTo(markersLayer);

      marker.bindPopup(
        `<b>${p.name || "–ó–∞–≤–µ–¥–µ–Ω–∏–µ"}</b><br>
        ${(p.address || "–ú–æ—Å–∫–≤–∞")}<br>
        –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${(p.category || "‚Äî")}<br>
        –°—Ä–µ–¥–Ω–∏–π —á–µ–∫: ${(p.avgCheck || "‚Äî")} ‚ÇΩ<br>
        –ö—ç—à–±—ç–∫: ${(p.cashback || "‚Äî")}%`
      );

      marker.on("click", () => {
        map.setView([p.lat, p.lon], 14, { animate: true });
      });
    });
  }

  function categoryColor(cb) {
    switch (cb) {
      case "fastfood":
        return "#22c55e";
      case "sport":
        return "#0ea5e9";
      case "entertainment":
        return "#f97316";
      case "active":
        return "#a855f7";
      default:
        return "#e5e7eb";
    }
  }

  // ====== –°–ü–ò–°–û–ö –ó–ê–í–ï–î–ï–ù–ò–ô (–ù–ò–ñ–ù–ò–ô) ======
  function renderList() {
    const list = document.getElementById("nearList");
    list.innerHTML = "";

    const nearHeader = document.getElementById("nearHeader");
    nearHeader.textContent = "–í —Ä–∞–¥–∏—É—Å–µ 3 –∫–º";

    // —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ "–¥–∏—Å—Ç–∞–Ω—Ü–∏–∏" –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –ú–æ—Å–∫–≤—ã (—É–ø—Ä–æ—â—ë–Ω–Ω–æ)
    const center = { lat: 55.75, lon: 37.61 };
    const sorted = [...filteredPoints].sort((a, b) => {
      const da =
        (a.lat - center.lat) * (a.lat - center.lat) +
        (a.lon - center.lon) * (a.lon - center.lon);
      const db =
        (b.lat - center.lat) * (b.lat - center.lat) +
        (b.lon - center.lon) * (b.lon - center.lon);
      return da - db;
    });

    sorted.forEach((p) => {
      const div = document.createElement("div");
      div.className =
        "near-card " + nearCardClass(p.cbCategory || "active");

      const distanceKm = (Math.random() * 2.5 + 0.3).toFixed(1); // —Ñ–µ–π–∫-—Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ

      div.innerHTML = `
        <div class="near-card-header">
          <div>
            ${p.name || "–ó–∞–≤–µ–¥–µ–Ω–∏–µ"}
            <div class="near-brand">${p.category || ""}</div>
          </div>
          <div>${distanceKm} –∫–º</div>
        </div>
        <div class="near-meta">
          <div class="near-distance">–ö—ç—à–±—ç–∫: ${p.cashback || "‚Äî"}%</div>
          <div class="near-check">~${p.avgCheck || "‚Äî"} ‚ÇΩ</div>
        </div>
      `;

      div.addEventListener("click", () => {
        map.setView([p.lat, p.lon], 14, { animate: true });
      });

      list.appendChild(div);
    });

    if (!sorted.length) {
      const empty = document.createElement("div");
      empty.style.fontSize = "12px";
      empty.style.color = "#9ca3af";
      empty.style.padding = "6px 2px";
      empty.textContent = "–ù–µ—Ç –∑–∞–≤–µ–¥–µ–Ω–∏–π –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —É—Å–ª–æ–≤–∏—è–º.";
      list.appendChild(empty);
    }
  }

  function nearCardClass(cb) {
    switch (cb) {
      case "fastfood":
        return "near-fastfood";
      case "sport":
        return "near-sport";
      case "entertainment":
        return "near-entertainment";
      case "active":
        return "near-active";
      default:
        return "near-active";
    }
  }

  // ====== –ì–ò–î –ü–û –†–ê–ô–û–ù–£ (–¢–û–õ–¨–ö–û –†–ï–°–¢–û–†–ê–ù–´) ======
  function prepareGuide() {
    // –ë–µ—Ä—ë–º —Ç–æ—á–∫–∏, –≥–¥–µ category —Å–æ–¥–µ—Ä–∂–∏—Ç "–†–µ—Å—Ç–æ—Ä–∞–Ω—ã" –∏–ª–∏ cbCategory == fastfood
    const restaurants = allPoints.filter((p) => {
      const cat = (p.category || "").toLowerCase();
      return cat.includes("—Ä–µ—Å—Ç") || p.cbCategory === "fastfood";
    });

    const center = { lat: 55.75, lon: 37.61 };
    restaurants.sort((a, b) => {
      const da =
        (a.lat - center.lat) * (a.lat - center.lat) +
        (a.lon - center.lon) * (a.lon - center.lon);
      const db =
        (b.lat - center.lat) * (b.lat - center.lat) +
        (b.lon - center.lon) * (b.lon - center.lon);
      return da - db;
    });

    guideRestaurants = restaurants.slice(0, 5);
    guideIndex = 0;

    renderGuideSteps();
    updateGuideCard();
  }

  function renderGuideSteps() {
    const container = document.getElementById("guideSteps");
    container.innerHTML = "";
    for (let i = 0; i < 5; i++) {
      const circle = document.createElement("div");
      circle.className = "guide-step-bubble" + (i === guideIndex ? " active" : "");
      circle.textContent = i + 1;
      container.appendChild(circle);
    }
  }

  function updateGuideCard() {
    const titleEl = document.getElementById("guideTitle");
    const subEl = document.getElementById("guideSub");

    if (!guideRestaurants.length) {
      titleEl.textContent = "–†—è–¥–æ–º –Ω–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤";
      subEl.textContent = "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–≤–µ–ª–∏—á–∏—Ç—å –æ–±–ª–∞—Å—Ç—å –∫–∞—Ä—Ç—ã.";
      renderGuideSteps();
      return;
    }

    const p = guideRestaurants[guideIndex];
    titleEl.textContent = "–ü–æ—Å–µ—Ç–∏—Ç–µ " + (p.name || "—Ä–µ—Å—Ç–æ—Ä–∞–Ω");
    subEl.textContent = p.address || "–ú–æ—Å–∫–≤–∞";

    renderGuideSteps();
  }

  function nextGuideItem() {
    if (!guideRestaurants.length) return;
    guideIndex = (guideIndex + 1) % guideRestaurants.length;
    updateGuideCard();
  }

  // ====== –û–°–ê–î–ö–ò (HEATMAP) ======
  function enterHeatMode() {
    heatMode = true;
    document.getElementById("heatOverlay").classList.add("visible");
    document.getElementById("mainPanel").style.display = "none";
    document.getElementById("btnBack").classList.remove("hidden");

    markersLayer.clearLayers();
    zonesLayer.clearLayers();

    averageZones.forEach((z) => {
      const color =
        z.avgCb >= 6 ? "#ef4444" : z.avgCb >= 5 ? "#f97316" : "#22c55e";

      const circle = L.circle([z.lat, z.lon], {
        radius: 4500,
        color,
        weight: 1.5,
        fillColor: color,
        fillOpacity: 0.25
      }).addTo(zonesLayer);

      circle.bindPopup(
        `<b>${z.name}</b><br>–°—Ä–µ–¥–Ω–∏–π –∫—ç—à–±—ç–∫: ${z.avgCb.toFixed(1)}%`
      );
    });
  }

  function exitHeatMode() {
    heatMode = false;
    document.getElementById("heatOverlay").classList.remove("visible");
    document.getElementById("mainPanel").style.display = "";
    document.getElementById("btnBack").classList.add("hidden");

    zonesLayer.clearLayers();
    applyFilters();
  }

  // ====== UI-–°–í–Ø–ó–ö–ê ======
  function initUI() {
    const tabCashback = document.getElementById("tabCashback");
    const tabNear = document.getElementById("tabNear");
    const cashbackSheet = document.getElementById("cashbackSheet");
    const osadkiBanner = document.getElementById("osadkiBanner");
    const btnBack = document.getElementById("btnBack");
    const guideNextBtn = document.getElementById("guideNextBtn");

    // –¢–∞–±—ã
    tabCashback.addEventListener("click", () => {
      tabCashback.classList.add("active");
      tabNear.classList.remove("active");
      cashbackSheet.classList.add("visible");
      currentCbCategory = selectedCbCategory || "all";
      applyFilters();
    });

    tabNear.addEventListener("click", () => {
      tabNear.classList.add("active");
      tabCashback.classList.remove("active");
      cashbackSheet.classList.remove("visible");
      currentCbCategory = "all";
      applyFilters();
    });

    // –û—Å–∞–¥–∫–∏
    osadkiBanner.addEventListener("click", enterHeatMode);
    btnBack.addEventListener("click", exitHeatMode);

    // –ì–∏–¥ –ø–æ —Ä–∞–π–æ–Ω—É
    guideNextBtn.addEventListener("click", nextGuideItem);

    // –ü–æ–∏—Å–∫
    document.getElementById("searchInput").addEventListener("input", () => {
      if (!heatMode) applyFilters();
    });

    // –õ–∏—Å—Ç –∫—ç—à–±—ç–∫–∞
    const options = document.querySelectorAll(".cashback-option");
    options.forEach((opt) => {
      opt.addEventListener("click", () => {
        options.forEach((o) => o.classList.remove("active"));
        opt.classList.add("active");
        selectedCbCategory = opt.dataset.cb;
        currentCbCategory = selectedCbCategory;
        applyFilters();
      });
    });
  }

  let selectedCbCategory = null;

  // ====== START ======
  window.addEventListener("DOMContentLoaded", () => {
    initMap();
    initUI();
  });
</script>
</body>
</html>
